// Day 14: Parabolic Reflector Dish - Part 2
// https://adventofcode.com/2023/day/14

var parabolicReflectorDish = function (input) {
  let grid = input.split(/\n/).map((line) => line.split(''));
  loopCycle();
  return countLoad(grid);

  function loopCycle() {
    const loops = new Map();
    const maxLoop = 1e9;
    for (let loop = 1; loop <= maxLoop; loop++) {
      cycle();
      const hash = grid.map((line) => line.join('')).join('\n');
      if (loops.has(hash)) {
        const extraLoops = (maxLoop - loop) % (loop - loops.get(hash));
        for (let i = 0; i < extraLoops; i++) {
          cycle();
        }
        break;
      }
      loops.set(hash, loop);
    }
  }

  function cycle() {
    print(grid);
    tiltNorth();
    print(grid);
    tiltWest();
    print(grid);
    tiltSouth();
    print(grid);
    tiltEast();
    print(grid);
  }

  function tiltNorth() {
    const rows = grid.length;
    const columns = grid[0].length;
    for (let col = 0; col < columns; col++) {
      let minRow = 0;
      for (let row = 0; row < rows; row++) {
        if (grid[row][col] === '#') {
          minRow = row + 1;
        } else if (grid[row][col] === 'O') {
          grid[row][col] = '.';
          grid[minRow++][col] = 'O';
        }
      }
    }
  }

  function tiltSouth() {
    const rows = grid.length;
    const columns = grid[0].length;
    for (let col = 0; col < columns; col++) {
      let maxRow = rows - 1;
      for (let row = rows - 1; row >= 0; row--) {
        if (grid[row][col] === '#') {
          maxRow = row - 1;
        } else if (grid[row][col] === 'O') {
          grid[row][col] = '.';
          grid[maxRow--][col] = 'O';
        }
      }
    }
  }

  function tiltWest() {
    const rows = grid.length;
    const columns = grid[0].length;
    for (let row = 0; row < rows; row++) {
      let minCol = 0;
      for (let col = 0; col < columns; col++) {
        if (grid[row][col] === '#') {
          minCol = col + 1;
        } else if (grid[row][col] === 'O') {
          grid[row][col] = '.';
          grid[row][minCol++] = 'O';
        }
      }
    }
  }

  function tiltEast() {
    const rows = grid.length;
    const columns = grid[0].length;
    for (let row = 0; row < rows; row++) {
      let minCol = columns - 1;
      for (let col = columns - 1; col >= 0; col--) {
        if (grid[row][col] === '#') {
          minCol = col - 1;
        } else if (grid[row][col] === 'O') {
          grid[row][col] = '.';
          grid[row][minCol--] = 'O';
        }
      }
    }
  }

  function countLoad(grid) {
    let count = 0;
    const rows = grid.length;
    const columns = grid[0].length;
    for (let col = 0; col < columns; col++) {
      for (let row = 0; row < rows; row++) {
        if (grid[row][col] !== 'O') continue;
        count += rows - row;
      }
    }
    return count;
  }

  function print(grid) {
    //grid.forEach((line) => console.log(line.join('')));
    //console.log();
  }
};

console.time('day-14_part-2');

var input = `O....#....
O.OO#....#
.....##...
OO.#O....O
.O.....O#.
O.#..O.#.#
..O..#O..O
.......O..
#....###..
#OO..#....`;
var expected = 64;
var result = parabolicReflectorDish(input);
console.log(result, result === expected);

var input = `O.#.#..OOO...#..#..O##..#...#.O#O.#O#...#O...OOO...#..O.....O.....#..#.O.#.........#.O#...#.OO....O#
O...O##O....O.#.#...#..#O..........#.....OO.O#.O...O.O#....O.O..O....#.#...OOO....O...O.....#.O.OO#.
..OO..O.#...#.#..O#.....#.O###..#.....O.O.O......#..........#...#..O.#.O..O..#OO.#......O.#O..#...O.
.#O..O...##..#.O.#...#..##.OO...#O.O...O.#..#O#O.O.#..........#.O...OO.....O#......O..O#OO...O#..OO.
.O#.#...O..O...OO....O.O..#.......O.#..O.#..#..O...#O.OO..#O.OO.O......O.......O..O..#...O..O.O#....
...OO..#..O.##....O..#.OOO..#......O#..OO..#.#..#.#......O...O.....O.OO....#...OO#...O...#.OO.O....#
..O#.#.#.##.#.#....#.O#...#..O##...#..O...O...#.O..#.O.OO.....O.O....#...O##.O.O.........O.O##...O#O
O.#O#....O....O..OO#O.O.......#.OO.O.##O..#..OO..#OO.#O...##..O..#..O#....#..#....O###......O..#...O
#OOO....#O#.O#.O.....O.OO......##....O......#OO...O.O.O#O#....O..O.......O.#.#.OO#O..O...#O.#....#.O
..O..O....#....#.#...##.#OO.....O.#O..#O........O.....#O.#...#O###......#.O...#.....OO....#.O.......
.O.##OOO..O..OO........OO#...O....O.O#.###...##......##..#..O....O.O#O.....#O....O.#..#O#.#....#.O..
.##O#O#..O.OOO......O.O.###.#..O.#.##O..O..#.##O.##.....O.O#.O#...OO.#.O.O.O..#..O..#OO...OOO......O
O#...##O......O#........O..#...O.#.O.##....O...#....O..#.#....O.#..........O.O..#O....OO.....O.#....
..O....#O...O#..O#.....#.....OOOO.OOOOO#..O....#.....#.O#..O...#.........O.....O....#O#....O..OO.O..
.#O.#..#..##...#.#O##O...#O....#.O.O.O....O.#......O........##.OOO...#......#..#..O.#..#O.O.O.O.#.O.
O....O..#.O##..#..O.##.O...O...O.#.....#....#.........OO.#O.OO...OO..O.O#...O...O.....#..#.O..#O....
O..#......#.##.O#..#O.....O#......O......#........###O#O.....OO.....O.##.O.O.O.##.##..#.O.....O....#
O..#...#O.#.OOO..........O.O..###.....##..#.##.O..##.....O..#OO...##...O#O#.O...O..O#.##...O..#O....
......O.......#....OOO...#O.O.#....OO#.#.#.##...O...#...O.OO....O.#.###..O.O..O##O.....O............
.....O..#.........O#....O#.O......##.O.....#.##OO....O...O.....#..O.OO.O..#..#.....#O..O.#.#..O.O#.#
...#......#.O.O.O.O#...#O....#.OO.......O..#..#.O.#......#.#.O##..O....#.#...O#...O...#..#.O....O#.O
O#.O..#.OO......O.O#.O.#.O.O#....O..OO.O..#.....#.....OOOO..##O#.O.......#...........O.#.#.O....OO#O
O....#.OO##.##.O..#.OO...O...O.O.#......O..O...##.#...#....OO..#....O.O..#O..#.....#........O....#O.
#O.O##..#O.#OO.#....OO#...O#.##.#.##...O....O...#O..O....#O#.#..#....O..O.#..#OO..O#..#O..O....O..O.
O.#O..O.O#..#...O.O..O.OOO.OO...OO#OO.O.O.OO#..#.#.........O#...O..O#..#.....OO.....#..OO...#...#..O
#...#....O#....#....#..#..........O........OO..#...OO.....O..OO#O..O..O..O..##..#....#.O.O....#.O...
#....O...O#O#......O...O...OOO.....O.O...O.OO#...O....OO.....O..O....O.O#..OO.O.#.O.O...O.O#.O#.....
.#....O....##..O.O.##...#.#OO.#.#OO......#.......O....O..#..##.#O...##O.O.#...#..O.O#....O....#OO.#.
.#.OO...#.OOOO......#.O.O...O.O...#....O....#.O..#OO....O......OO.....##.#.OOO#..#.#O#.....O....#..O
.....O.....O#..O.O.##O.O.#...O#OO...#....#O.........##...#.....#.O.O#..O.........OO..O...#......#.#.
.........O.#.#..O..#.#.OOO#O..##O..O#..OO...O.O#.O...###.........O...O..O..O...#O..O....#..#...#O.OO
.#O..O....#..##.....#..O.OO...#.#OO.#.#........##.O.....#..........#.#.O#O..OO.OO.#...O....#...O...#
.O.O....#OO.#..O...O...O#.OOO#......#.O...O...##.OO..#..OOO.#.#OO......##OO....#....###.O#...#O#...O
.O#.....#...#O.O.....O...#.O#O....O.O....#..#####..............O.#...O#O#OOOO...#.#...O..O.#.OO.O..#
...#.#..O.#......O...O##.#....#.O......#.....O......#O#.O.OO....OO..#O.O.#.O.#...O#..O##.#O.O..OO.O#
##OO...O....O.##..O.....#..OO##.#.#.O..........O#.O....O##...O.O....#O..O.O.##...#.#O##.......OO...O
#O.#.......#........O......O....#........#O##..O.O..OO..O......OO.....O#O..OO.#......#O.....#.......
....OO...OO.#.#...#..........O#....O#.#.#OOO..#......#.OO#..#O..........O..O....#....O..O.....#.....
.......##O.....#O..#OO..#OO..#O.....O..O.#.O#OO........O.O..O..O......OO...#...OO#.#.##O...#O..#..#.
O......#..O#.........#O.OO#O..#.O......O.#.O.....##..#.O.....OO..O.#..O...O.#...O#.O.#O..O..#...OOO#
..O.O##...O..OO#....#O...OO.....#..O.O.........OO#....O..#...OO...............OO.O...#........#OO.O#
#.....O.....O.#.....O..#O#O#..#.O.#.O...O.O.#.O...#O..#..O.O....O.O..##.#OO.#.O..................O#.
...O....O.OO...O.OO.O......O......O.O#.OO.....O.O..#...O#O#.......#.#OO..#...O..#..O..OO..OOOO.O.O..
.#..OO.O...#.O.....#...##.O....#.....#OO#O.#..#.O...........#O..O....O....#O...O....#.#...O#....O...
....O..####...O..........O..OO.#.#..#....##...##.O.#.....O.#O.#...##.......OO.O.......#.#O.O.O.#..O.
#..#..#.OO..#.#..#####..O#OOO..OO.#.##.O.O.O.O..O...O.O###.....#.#.#........O.O....#.O...#.#.#.....#
.OO.#O...##...#..O..#O..O.#.#O........O..#..O....O..#..OO.O...#..#.#......#..#O........##.O.....O...
O.....#.O.O.#..O.#..O...OOO..#.OOO#..O......O#..O..O#...#O#...O..........O...O.O##....O.O.O.....O..O
#.#O.O.#O#...O..#.#......##..O.OOOO....O.#.....O..O..OO....O.O##....O#.#..O.O.O#.......OO..#O.......
...O...#......O#.O#..O###.......#.O....O#O.#.O.O#..O##...#....O..OOO....O..O.....#..#O.....O.OO.....
O..O....#O#....#..O....#..##..........O..#.OO.....OO.O.#O..#O.O#O....OO.O....#.O.#O.OO...#..#..O...#
#.O#OO.OO#.O#.#....#.......O..OO...#.O...OOO.O..O...OO#..O..#.O..#..OO....#.#......#O......#.O..O..O
.#.......#....#.O#O..O..........#.O.O.......##.#.O#####.....O.O.....#....O.#.O...O...OO#.#O.O##.....
O.O......OO....#.#........##.O.#.O.#...O#OO......O..#.O...O.O..O#.....#O#.OO#....OO.#.#....#..#..#.O
O.....OO...#O...#.O..O.....O.OO.#.##.OOO##..#.O.OO.##...O.O.......O.#......#.O#.....O.#..O...O......
......O.##.#.............O.O.O#.##..#O#O..O..O.#.O.#O..#....#.......O.......O...O#..###.OO...O#OO...
O.#..##O..#O......O.#.#.OO.O#O.O##..O.OO..OO#.OO...O..#.#...O...O.#.#...O....O#...##..O#......#...OO
...OO...O#.O.O......O...#..O##.#OOOO.O.##O....O##..#...O.OO.......##..OO#.O......O#O...O..#.......O.
..#.O#O#.O#......#....O.OO..O#.O..#.....O....#..OO#.#.O#.O........O..OOO#OO.OOOO..O.....#.O...#..#.#
.O.....#.#.#.#O.......O..O#..#O#.....O.##.......OO......#OO.....#OO.#.....##...O.O...O..O..O......##
.O#.#O...#..#.OO#OO#.O.O.......#..OO#.#O.O#O.O.##..O..#.....OO#.....O..O..OO.O.O#.#.#..O.......OO.O.
.#OO..#.......O.O....#....O...O..#......#.#OO.O#...O..O..O.###.....#.#............O....O....O.OOOO.O
OO..#O#...#O..##.........O#...#......O...#....O....#O......O.......#.O.......##...#OO...#..###...###
#.O#O#OOO...#.......O......O...#O..#......#....OOO.#O.....O....#....##.O#.#....O.O........#..#.O...#
.O...#..##O..O..##.O#....OO#..#O#OOO.OOO#.#.#..#.O.....O#O..O.O..#..OOOO..O..O...#.#.#..O.O....O....
...#.OOO.OO....O#O#....##..OO...O..O..O......O...#O#O...O.#O..##O.......O..O#.......##O..........OOO
.....OO...O....OO.O..O..O##..OO...#.O.##...O.##.#..#O..........O....O...O.OO..O..O#..O.#..O#..#.O#..
.O..O#.O.O.#...O...O.O......O..O..OO..OOO#..O.....#...O#..###..O.O.....#..##...O#....#.O.......#...O
.O........O#O.#.#O#O...O.O...#O...O..O........O#O.##..O...#.....O..O........O#.#...O..OO..O...O#O...
#.##..#O....#..O...O##..##..O..#....##O...#.O.#...##...O.O..O#O..O.#.....O...O#......OO....O.#....##
O#..#O...#......#OOOO..OO.#O.....O..OO..#.....#..O....O....OO..#...O.O.....O#...#.......O#..O.......
#O...O........O##O.#....O..O...##.#O...O.O.O......O....O.O#.O#O....#.O....O#....##O.#..O....##.O..OO
..#....O.##...#.#O#...#..O....#...#.#..O..#..#.O.#.O..####.O.O.####.OO..OO...OO...#....OO.##O.O.#.O.
..OOOO..#.....O...#O#O.O.....#....##....O..O....O..O.O.....O.#..O..#O....O.OO..OOO#..#.#O...#.#..O..
.#.O......#..O#.#..##.###..#..#.....##......#...#O.#.O..#O..O.O..O.#..#OO.O.#O.O......#..#...O....#.
..#...##.O....#..OO...#O.#..O..#OOO..O.O.....O.#OOO#O....O........O#...O.#..............O.....#.O.#O
......O.OOO.#..............#O...#.O........#..O.......O.....#.O..#O........#O##..O##O#.....O.....O.O
.#.#....OO.##...OO...O#O.O.#.O..O.O.O...#...#...........O...O.O##.#..#O..O.....O#....O..#.....#....#
.O....O#O.#.#.O..O..#....#..O.OO...#.O.....#O...........O.......O....O......##.....OOO..#......O.O#.
##...#...O.....O......OOO#...#O...O##.......#O..O......O......O..O.#.O#O..O..O....O.....#..O...O...#
......O#.#...#.O.O#.##.#O#OO.##.O#.....O.O..O....O.O#.......O#OO...O...#.....O#...#.#..O.O..#O#..O##
OO.#.OO#..#....O.#O#.O..#...#O..OO...#O#.O.O..O..O.O.######O..O#....O#..O.O.....O##.O..O.O#O.##O.O..
...O...#...O..#...O.O.O..#OO.O.#O.#.O.....O#.OO..O.#.O.....#.O.#.OOO..O#OO.O....O...O##........O#O..
..#.....O........O#.OOOOO...O.#....OOO.#.O.#..O#O#O..#.#O.O.#O.#O##O........O...#.OO.#.........O.O.O
.....OO...O..#O.O..OO#O...#O........O.O.##......O..#..#OO.....O..###.........O...#....O......OOOOO..
......#...O.....#...#.O.##.OO..O#.O..O.#.#.O.....O......#O.#O.#O#O...O...O..O#.....#.#O#..#.O.#..#.#
OO.#.O..#...OO##..OO....O.#.O###...#.O......OO#....O.....O..#O...#.....O#OO......O.......#.O..#.##O.
.#O....OO.#.#...O......O..O#..O#.O......#O..O#.##...O#...#O#....#.OO..#........O#...O#.O....#....##.
.#.OO....#.#.....O#O.O##O.##O.O.#..##O#..#.#.#O#.OO..O.....###.O.#...##.....#.....O......OO.#O.O..#.
.#O....O.O.O.OO.O..OO...O.###O...O....#.O.OO#O..#....O.##O...O....#OO..O..O...O.#...O..O.#.O...O.#.#
..O........O.O#..#.#.O.O.......OO.#.O...##..O#.#.......#..#...#.#...O.....##.O........#O..#OO.....#.
##...O....O.#.....OOO.#...O.#.........#...#....#.#..#......#..O..##O#.O..O.#.O.##.#........O#.....#.
...O..#O...O......O.#O..#.##...O...O.......OO.#...........O..#.#...OO#....................#O#OO#O...
O#..#O.......O.#OO....O.......OO.O......O.#.....O......#.O.##..O.O#..OO..##O.....###.O...O....OO.O..
.O....#....O...#.O..O.#......O#..O..#OO..O..##...O..O...O.#..O.....O#O.#.OO...#.#.....O#......O...OO
..O.OO...OO...O..O.O.OO.O.#....OOO...O...##O.#O...#....#O.#O.O....OO..O..........O.O.....#.....#OO#.
.OO#...O.#..O.#.OO..O...O.O...##.....#O.#.O.....O...O....#.O...O.##......OOO....O....O.....#.#.O..O.
......#..#...#O.##...O..#OO##...#....#.#.......O.##.##..OO#O.O.....#..O#.O..#O.....#.O.O.#.#..#O#.O#
..#....O#..#O....#.#....O..O#...O...OO......#...#.O.#.##..#....#OOO#.O.O.O...O#...O.O.O.O...O#O...#.
..O.......#OO.OOO......#O#.O.#O.O......O..O.O.O.O.....#.###O.O#OO.#O.#O...O...OO##O#.........O#.....`;
var expected = 90928;
var result = parabolicReflectorDish(input);
console.log(result, result === expected);

console.timeEnd('day-14_part-2');
