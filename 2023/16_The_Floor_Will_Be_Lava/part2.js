// Day 16: The Floor Will Be Lava - Part 2
// https://adventofcode.com/2023/day/16

var theFloorWillBeLava = function (input) {
  const debug = false;
  let result = 0;
  const grid = getGrid(input);
  const rows = grid.length;
  const cols = grid[0].length;
  for (let r = 0; r < rows; r++) {
    const countLeft = countEnergizedTiles(grid, [r, 0, 0, 1]);
    const countRight = countEnergizedTiles(grid, [r, cols - 1, 0, -1]);
    //console.log(r, countLeft, countRight);
    result = Math.max(result, countLeft, countRight);
  }
  for (let c = 0; c < cols; c++) {
    const countDown = countEnergizedTiles(grid, [0, c, 1, 0]);
    const countUp = countEnergizedTiles(grid, [rows - 1, c, -1, 0]);
    //console.log(c, countDown, countUp);
    result = Math.max(result, countDown, countUp);
  }
  return result;

  function countEnergizedTiles(grid, config) {
    const rows = grid.length;
    const cols = grid[0].length;
    const map = Array.from({ length: rows }, () => new Array(cols).fill('.'));
    const hVisited = new Set();
    const vVisited = new Set();
    let q = [config];
    while (q.length) {
      const qq = [];
      for (const [r, c, dr, dc] of q) {
        const cell = r * cols + c;
        if (grid[r][c] === '.') {
          if (dr === 0) hVisited.add(cell);
          if (dc === 0) vVisited.add(cell);
        }
        map[r][c] = '#';

        const nextDirections = getDirections(grid, r, c, dr, dc);
        for (const [ndr, ndc] of nextDirections) {
          const [nr, nc] = [r + ndr, c + ndc];
          if (nr < 0 || nr >= rows || nc < 0 || nc >= cols) continue;
          const nextCell = nr * cols + nc;
          if (ndr === 0 && hVisited.has(nextCell)) continue;
          if (ndc === 0 && vVisited.has(nextCell)) continue;
          qq.push([nr, nc, ndr, ndc]);
        }
      }
      q = qq;
    }
    print(grid);
    print(map);

    let result = 0;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        if (map[r][c] === '#') result++;
      }
    }
    return result;
  }

  function getDirections(grid, r, c, dr, dc) {
    const cell = grid[r][c];
    if (cell === '.') return [[dr, dc]];
    if (cell === '|') {
      if (Math.abs(dr)) return [[dr, dc]];
      return [
        [-dc, dr],
        [dc, dr],
      ];
    }
    if (cell === '-') {
      if (Math.abs(dc)) return [[dr, dc]];
      return [
        [dc, -dr],
        [dc, dr],
      ];
    }
    if (cell === 'X') {
      // -1,0
      return [[dc, dr]];
    }
    if (cell === '/') {
      return [[-dc, -dr]];
    }
  }

  function print(grid) {
    if (!debug) return;
    const cols = grid[0].length;
    const headers = Array.from({ length: cols + 2 }, (_, i) => (i === 0 || i === cols + 1 ? ' ' : i - 1));
    console.log(headers.join(' '));
    grid.map((line, i) => {
      line = line.map((ch) => (ch === 'X' ? '\\' : ch));
      console.log([i, ...line, i].join(' '));
    });
    console.log(headers.join(' '));
  }

  function getGrid(input) {
    return input.split(/\n/).map((line) => line.split(''));
  }
};

console.time('day-16_part-2');

var input = `.|...X....
|.-.X.....
.....|-...
........|.
..........
.........X
..../.XX..
.-.-/..|..
.|....-|.X
..//.|....`;
var expected = 51;
var result = theFloorWillBeLava(input);
console.log(result, result === expected);

var input = `X.......................X..........................................-..................-.../................-..
....../.......X...-......-.|...X..............X.................|............././....-........................
...............-...-........................................X......X..-.............|......-....X....-........
..X..|.|...........................-.|........................................./.|....|................|......
|../................|............................................................X........../..X..............
........X............../................/..........................X...X....|............./....-.........XX...
.................-...-...................X../........-|.................../......-...........|................
........-............/...|-............-.....X.|..............-....-../X../..................X...X././........
........................-|................................................................-........-..........
-......./.................|.....X.................X.....//............-........./..../....|...................
....-.............-........-..........-|.......|...../...X...................X.....................|..........
...|...X.........|.................|.....|....-....X.......X./........................-.../..../.....-........
....|....-.-..............X.........|.......................-.......-..............X................/.........
.....|.X...........-.................-.-........../...X............|...............|...|......./.......|...../
.....X.........................-.../..-./...X...................../......X...-.......|.X........-|............
............|.....................................-....../....X.............../-...|...X..X................./.
......-./|....../............|.........X............-../...-......./.X..X....../......|/...X..................
................................|.......|..-..../.............................../.-..................-..-/..|.
...............................-......./......................|./...............-............./....../........
..................../....................X........X...........................-............/.../..............
.|||......../.................|.................../..X............................-......./..|...|/.-.........
......-......./X....../.........|....../.......-...............|.X........-............/.../..................
.....................-.X/|................//.../.........|.|......X.-..|.........|.........X..................
.........................X/.......|.|............................|........|.............................././..
.................................|.................X../..|/.................X.................-...-........-/.
......................-...-.........../...........................X....X......-..-.......X.-....X....|........
......-......../..............X/..................X..|........-..............|...-...../......|...............
|.......|.../....|..............//.....................|..........|/......../................|................
...|.|..................../|..../.-.......-...........|.....|./....X......-......-................|...........
......X/./.|X..../|.|..|..........-....|...........|.-.|...................-.X.....|....................X.....
......../.X......................|.....|...........|.........../.......|....|...|.......-......../......X...-.
...|...-...||......-..|..-...........|.-.................|.................................-..................
..............-.X.-........|......X..........................................X./.X........../.....|...........
../X.........|...............|............|.X/.-/.................-....|...-.................-.....|..../.....
....................../......../..../-.....X........................X..-.X....|....-.........../-.............
.................................|................|.........|................../|.....|....XX............/.X..
...///./.....X.................|/.....................X...................-............|................|.....
............-...........................--........X................/.............-X................X.....-.../
...............X.........../|............................|.....................X...-...X.....................-
...X.............|.............|................X............X|...../...|.........................|...........
..................|......|..........-.-..............X.........................X..............................
....-................../.........../...|................/...............|./.|.../....X..../......./......//...
...../....../..............................|...X../..........-..........-........-..//..../...................
...............-......|......................|./........./............/..-...........|../.....-........-./....
..X.........................|...-.......X.................|..............-........X....-.............-....|...
.......|......|....../........X...........|......-........../......-..................../....................X
.......................|....-..|........./.|.-...............|..X......X.....-.......X...-/....|/.........X...
X......X..-.....................X..........................X................................../...........X...
-....-......../............................................................../.X.......|..............|....-..
........|......................|.............-....X................................./..X.......|..........-...
...-...............|........./......X...../.......|...|...............X.../...X.../......|.....-.X......X.....
............./.....|......................|.....................................X...||.................-....|.
./.....-................/........|./....-......../......./..............X..................................X..
.../..../X........-..........................|.-/.|..X................XX-.......|......./...||.......|........
.....-.........................-...............X...........|.............-.X.../.|......-.|......../...-.....-
......X....................|...../......................|.../......-..|............|......./.../.........|....
...|...........-....................................../.|............./....|..../........./.....X../..........
....../.../................X........................X...X....X......X............../|...............X.-.......
./....X.../.............|............................-.../............../............/...........X...|........
............................|.................|/..........//.........../..-...............|...................
.....X......X.................|.....|...X-./...............X................|....../.....-..X........-....-...
........................./-........X................./........-/.|....-.......X............-/X......|.X...-...
..../../..|.|...............X.......................................-.........................................
...........|...................................................-...-......|..................X............../.
/....|......................................................................|X.../.......-...........-...|....
......|.-.X......-........|.....-..|.X..............-......./......-|.........................-...............
............X......................................|........................|.-...............................
.........-.........../....X./....../.-...-..//.........../.......XX...........................................
........X......../............./...-......X.../..|..|............................../......../..X..............
--.........|.....-...|............../...|.......|..............X|............|.........................|.-....
-X......./..............-....-....X...|.-........X/.X./............-/...X........|-.........../../...X........
.X|X..............-......-.X...-....X..........................X........|...........-......./.............../.
..........................|...X..../.../..........X.............-...//...............X..................-.....
........./..........................X............|-.....|..-...|......../........-...........................X
.......X.../.....X....../.......|..|...............-......................|....-...................-.|........
......|.......X.../..............................-..............................|......-.-...................X
/.....|.......-............/|.....|-......./..../......-........../..|......../.-..X..../....../...|..........
............/..--..........-............X.......X................X........................../../....|.........
..|..-................|.|..|................/.......X............-//.......................X..X...............
.......................-......-..................|....X................-......X.|....X....|..../../|.-........
........................-..................-...........................-..-................-................|.
/.X....|.-.................................X..-.....X./.........../-.|..............X..X.....--|/....X........
.......-..-../..................X..--|..............|...............|X........|...--................|./.X.....
..........|................-.......|..................................................|...................|...
-.-..|....-.|........-./...|.-.........X.....X/........-........X........../................./.../........X...
..................../...|/......................................../............X.|./../................/X|....
...//.........................X....../..............X../.......-..X....|......................................
............................./..|./../.........-/..X..........................................................
......X.....|..................|..................X.....X.-..X...../............................../...........
..........X...........-..........-.....-....X/................../.................................X.....|..X..
..../.X...................................X............X...X....|.................|.....................-.....
...........-...........................X.......|-../.|....|.....|......................-...../................
.......|.........X..............|....X...-......../...........-.....-..-...........-..................X...X.|.
...........|.......................|....-..........X............................X.................../.X.......
..../.................X.......-..|.................../........................|...............X...........-.|.
............./..|.-X..../.....-............-....|..X......|......../............-.........|................X..
...................X...X/......X............|......................X....|...................-./-..............
..-X...........|.................../.....|....|............................-..|............X.............X....
.|.....X....X........|..................X...............|..-/.........|.-/...........-............-...........
.....X...../......-............|........./..|............-........................X....-......................
......X......../........|..............X...-..-...|.......................................................|...
...................|.................................X.....X...........................|../.|.-......-........
..................|..............X.....X............|........../....../...............X.........X.............
..|...........-..../....X.........--...X................../.............-...-....................-..../....|..
.|...X...................|......-...........-X..........X.....|.....|..........|.........|....|-../...........
.............X|...................../X...............X....../.......-....X.....................-..............
.......//.....................X....X......X......X.........|...................../......../.........X......-..
.X./.........-...-./-.X.............../......|................................X|....X...../....-..............
.......|......../......../......./.........../...............|............................../..|......../.....
............./.........|.....-./.........../....-......./|......-................|............................`;
var expected = 8335;
var result = theFloorWillBeLava(input);
console.log(result, result === expected);

console.timeEnd('day-16_part-2');
